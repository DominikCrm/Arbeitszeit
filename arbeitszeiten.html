<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Arbeitszeiten & Gehaltsrechner</title>

<style>
:root{
  --bg:#0f172a;
  --card:#1e293b;
  --text:#e5e7eb;
  --muted:#94a3b8;
  --accent:#38bdf8;
  --danger:#ef4444;
}

*{box-sizing:border-box}

body{
  margin:0;
  font-family:system-ui, sans-serif;
  background:var(--bg);
  color:var(--text);
  padding:16px;
}

.container{max-width:1100px;margin:auto;}
h1,h2{margin:8px 0;}
.card{
  background:var(--card);
  border-radius:14px;
  padding:16px;
  margin-bottom:16px;
  box-shadow:0 10px 30px rgba(0,0,0,.35);
}
.flex{
  display:flex;
  gap:10px;
  flex-wrap:wrap;
  align-items:end;
}
.table-wrapper{overflow-x:auto;}
table{
  width:100%;
  border-collapse:collapse;
  min-width:700px;
}
th,td{padding:10px;text-align:center;}
th{color:var(--muted);font-weight:500;}
tr:not(:last-child){border-bottom:1px solid #334155;}
input,select{
  width:100%;
  padding:10px;
  border-radius:8px;
  border:none;
  background:#020617;
  color:var(--text);
  font-size:1em;
}
button{
  padding:12px 14px;
  border-radius:8px;
  border:none;
  cursor:pointer;
  font-weight:600;
  font-size:1em;
}
.primary{background:var(--accent);color:#020617}
.secondary{background:#334155;color:var(--text)}
.danger{background:var(--danger);color:white}
button:hover{opacity:.85}
.salary{font-weight:700;color:var(--accent);}
.summary p{font-size:1.1em;margin:6px 0;}

@media(max-width:700px){
  h1{font-size:1.4em;}
  table{font-size:.9em;}
}
</style>
</head>

<body>
<div class="container">

<h1>üóìÔ∏è Arbeitszeiten & Gehaltsrechner</h1>

<div class="card flex">
  <div>
    <label>Abrechnungsmonat</label>
    <input type="month" id="month">
  </div>
  <button class="primary" onclick="saveMonth()">üíæ Speichern</button>
  <select id="savedMonths" onchange="loadSelectedMonth()">
    <option value="">üìÇ Gespeicherte Monate</option>
  </select>
</div>

<div class="card">
<div class="table-wrapper">
<table>
<thead>
<tr>
  <th>Datum</th>
  <th>Schicht</th>
  <th>Paletten</th>
  <th>‚Ç¨</th>
  <th></th>
</tr>
</thead>
<tbody id="tbody"></tbody>
</table>
</div>
<br>
<button class="primary" onclick="addRow()">‚ûï Schicht hinzuf√ºgen</button>
</div>

<div class="card summary">
<h2>üìä Monats√ºbersicht</h2>
<p>Schichten gesamt: <span id="totalShifts">0</span></p>
<p>Gesamtgehalt: <span id="totalSalary">0 ‚Ç¨</span></p>
</div>

<div class="card summary">
<h2>üìÖ Jahres√ºbersicht</h2>
<p>Schichten Jahr: <span id="yearShifts">0</span></p>
<p>Gehalt Jahr: <span id="yearSalary">0 ‚Ç¨</span></p>
</div>

</div>

<script>
const tbody=document.getElementById("tbody");
const monthInput=document.getElementById("month");
const savedMonths=document.getElementById("savedMonths");
const totalSalary=document.getElementById("totalSalary");
const totalShifts=document.getElementById("totalShifts");
const yearSalary=document.getElementById("yearSalary");
const yearShifts=document.getElementById("yearShifts");

function addRow(data={}){
  const tr=document.createElement("tr");
  tr.innerHTML=`
    <td><input type="date" value="${data.date||''}"></td>
    <td>
      <select>
        <option value=""></option>
        <option value="normal" ${data.type==='normal'?'selected':''}>normal</option>
        <option value="doppel" ${data.type==='doppel'?'selected':''}>doppel</option>
        <option value="extra" ${data.type==='extra'?'selected':''}>extra</option>
      </select>
    </td>
    <td><input type="number" min="0" value="${data.pallets||''}" ${data.type==='extra'?'':'disabled'}></td>
    <td class="salary">0</td>
    <td><button class="danger" onclick="this.closest('tr').remove();calculateAll()">‚úñ</button></td>
  `;
  const typeSelect = tr.querySelector("select");
  const palletsInput = tr.querySelector("td:nth-child(3) input");
  
  // Schicht-√Ñnderung: Paletten nur bei 'extra'
  typeSelect.onchange = () => {
    if(typeSelect.value==='extra'){
      palletsInput.disabled=false;
    } else {
      palletsInput.disabled=true;
      palletsInput.value='';
    }
    calculateAll();
  };

  tr.querySelectorAll("input").forEach(e=>e.oninput=calculateAll);
  tbody.appendChild(tr);
}

// Rundung auf n√§chsten 5er
function round5(v){ return Math.ceil(v/5)*5; }

// Berechnung pro Schicht
function calc(type,p){
  if(type==='normal') return 45;
  if(type==='doppel') return 90;
  if(type==='extra') return round5(45+Math.max(0,p-17)*3.3);
  return 0;
}

// Robust Datum parsen (DD.MM.YYYY oder YYYY-MM-DD)
function parseDate(dateStr){
  if(!dateStr) return null;
  if(dateStr.includes('.')){
    const [d,m,y] = dateStr.split('.');
    return new Date(`${y}-${m}-${d}`);
  }
  return new Date(dateStr);
}

// Berechnung Gesamt
function calculateAll(){
  const month=monthInput.value;
  if(!month) return;
  const [y,m]=month.split('-').map(Number);
  const start=new Date(y,m-2,21);
  const end=new Date(y,m-1,20);

  let sum=0,count=0;

  [...tbody.children].forEach(r=>{
    const dateStr = r.children[0].querySelector('input').value;
    const t = r.children[1].querySelector('select').value;
    const p = +r.children[2].querySelector('input').value || 0;
    const d = parseDate(dateStr);
    let s=0;

    const palletsInput = r.children[2].querySelector('input');

    // Validierung
    if(d && t){
      if(t!=='extra') palletsInput.value='';
      if(t==='extra' && p<0) palletsInput.value=0;

      if(d>=start && d<=end){
        s=calc(t,p);
        sum+=s;
        count++;
      }
    }
    r.querySelector(".salary").textContent=s;
  });

  totalSalary.textContent=sum+" ‚Ç¨";
  totalShifts.textContent=count;
  calculateYear();
}

// Monatsdaten speichern
function saveMonth(){
  const m = monthInput.value;
  if(!m) return alert('Bitte Monat w√§hlen!');
  const data = [...tbody.children].map(r=>({
    date:r.children[0].querySelector('input').value,
    type:r.children[1].querySelector('select').value,
    pallets:r.children[2].querySelector('input').value
  }));
  localStorage.setItem('month-'+m,JSON.stringify(data));
  loadMonthList();
  alert('Monat gespeichert!');
}

// Monat laden
function loadSelectedMonth(){
  const m = savedMonths.value;
  if(!m) return;
  monthInput.value=m;
  tbody.innerHTML='';
  const data = JSON.parse(localStorage.getItem('month-'+m));
  data.forEach(addRow);
  calculateAll();
}

// Liste gespeicherter Monate
function loadMonthList(){
  savedMonths.innerHTML='<option value="">üìÇ Gespeicherte Monate</option>';
  Object.keys(localStorage)
    .filter(k=>k.startsWith('month-'))
    .sort()
    .forEach(k=>{
      const m = k.replace('month-','');
      const o = document.createElement('option');
      o.value=m; o.textContent=m;
      savedMonths.appendChild(o);
    });
}

// Jahres√ºbersicht berechnen
function calculateYear(){
  let sum=0,count=0;
  Object.keys(localStorage).forEach(k=>{
    if(k.startsWith('month-')){
      JSON.parse(localStorage[k]).forEach(r=>{
        if(r.type){
          sum+=calc(r.type,+r.pallets||0);
          count++;
        }
      });
    }
  });
  yearSalary.textContent=sum+' ‚Ç¨';
  yearShifts.textContent=count;
}

monthInput.onchange=calculateAll;
loadMonthList();
for(let i=0;i<5;i++) addRow();
</script>

</body>
</html>
