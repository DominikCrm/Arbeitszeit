<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Arbeitszeiten & Gehaltsrechner (Online)</title>

<style>
:root{
  --bg:#0f172a;
  --card:#1e293b;
  --text:#e5e7eb;
  --muted:#94a3b8;
  --accent:#38bdf8;
  --danger:#ef4444;
}
*{box-sizing:border-box}
body{
  margin:0;
  font-family:system-ui, sans-serif;
  background:var(--bg);
  color:var(--text);
  padding:16px;
}
.container{max-width:1100px;margin:auto;}
h1,h2{margin:8px 0;}
.card{
  background:var(--card);
  border-radius:14px;
  padding:16px;
  margin-bottom:16px;
  box-shadow:0 10px 30px rgba(0,0,0,.35);
}
.flex{
  display:flex;
  gap:10px;
  flex-wrap:wrap;
  align-items:end;
}
.table-wrapper{overflow-x:auto;}
table{
  width:100%;
  border-collapse:collapse;
  min-width:700px;
}
th,td{padding:10px;text-align:center;}
th{color:var(--muted);font-weight:500;}
tr:not(:last-child){border-bottom:1px solid #334155;}
input,select{
  width:100%;
  padding:10px;
  border-radius:8px;
  border:none;
  background:#020617;
  color:var(--text);
  font-size:1em;
}
button{
  padding:10px 12px;
  border-radius:8px;
  border:none;
  cursor:pointer;
  font-weight:600;
  font-size:0.95em;
}
.primary{background:var(--accent);color:#020617}
.secondary{background:#334155;color:var(--text)}
.danger{background:var(--danger);color:white}
.delete{background:#f59e0b;color:white}
button:hover{opacity:.85}
.salary{font-weight:700;color:var(--accent);}
.summary p{font-size:1.1em;margin:6px 0;}
#user-bar{display:flex;gap:8px;align-items:center;flex-wrap:wrap;}
#extra-amount {flex: 1; min-width: 200px;}
.extra-field {
  display: flex;
  flex-direction: column;
  gap: 4px;
}
@media(max-width:700px){
  h1{font-size:1.4em;}
  table{font-size:.9em;}
}
</style>
</head>

<body>
<div class="container">
<h1>üóìÔ∏è Arbeitszeiten & Gehaltsrechner (Online)</h1>

<div class="card" id="user-bar">
  <button class="secondary" id="login-google">Mit Google anmelden</button>
  <button class="secondary" id="login-apple">Mit Apple anmelden</button>
  <button class="danger" id="logout" style="display:none;">Abmelden</button>
  <span id="user-info"></span>
</div>

<div class="card flex">
  <div style="flex:1;">
    <label>Abrechnungsmonat</label>
    <input type="month" id="month">
  </div>
  <div id="extra-amount" class="extra-field">
    <label>Sonstiges (‚Ç¨)</label>
    <input type="number" id="extraAmount" min="0" step="0.01" value="0" placeholder="z.B. 50.00">
  </div>
  <button class="primary" onclick="saveMonth()">üíæ Speichern</button>
  <select id="savedMonths" onchange="loadSelectedMonth()">
    <option value="">üìÇ Gespeicherte Monate</option>
  </select>
  <button class="delete" id="deleteMonth" onclick="deleteSelectedMonth()" style="display:none;" title="Ausgew√§hlten Monat l√∂schen">üóëÔ∏è L√∂schen</button>
</div>

<div class="card">
  <div class="table-wrapper">
    <table>
      <thead>
        <tr>
          <th>Datum</th>
          <th>Schicht</th>
          <th>Paletten</th>
          <th>‚Ç¨</th>
          <th></th>
        </tr>
      </thead>
      <tbody id="tbody"></tbody>
    </table>
  </div>
  <br>
  <button class="primary" onclick="addRow()">‚ûï Schicht hinzuf√ºgen</button>
</div>

<div class="card summary">
  <h2>üìä Monats√ºbersicht</h2>
  <p>Schichten gesamt: <span id="totalShifts">0</span></p>
  <p>Schicht-Gehalt: <span id="shiftSalary">0 ‚Ç¨</span></p>
  <p><strong>Gesamt (inkl. sonstiges): <span id="totalSalary">0 ‚Ç¨</span></strong></p>
</div>

<div class="card summary">
  <h2>üìÖ Jahres√ºbersicht</h2>
  <p>Schichten Jahr: <span id="yearShifts">0</span></p>
  <p>Gehalt Jahr: <span id="yearSalary">0 ‚Ç¨</span></p>
</div>

</div>

<!-- Firebase SDKs -->
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore-compat.js"></script>

<script>
// === FIREBASE CONFIG ===
const firebaseConfig = {
  apiKey: "AIzaSyBkOZNvEpg0OcBkffwtyDm-ar6VAeucYFk",
  authDomain: "arbeitszeit-c3243.firebaseapp.com",
  projectId: "arbeitszeit-c3243",
  storageBucket: "arbeitszeit-c3243.firebasestorage.app",
  messagingSenderId: "8215248023",
  appId: "1:8215248023:web:cf7465987b5cdfa36fbdd2"
};

firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db = firebase.firestore();

// === DOM-Elemente ===
const tbody = document.getElementById("tbody");
const monthInput = document.getElementById("month");
const extraAmount = document.getElementById("extraAmount");
const savedMonths = document.getElementById("savedMonths");
const deleteMonthBtn = document.getElementById("deleteMonth");
const totalSalary = document.getElementById("totalSalary");
const shiftSalary = document.getElementById("shiftSalary");
const totalShifts = document.getElementById("totalShifts");
const yearSalary = document.getElementById("yearSalary");
const yearShifts = document.getElementById("yearShifts");
const loginGoogle = document.getElementById("login-google");
const loginApple = document.getElementById("login-apple");
const logoutBtn = document.getElementById("logout");
const userInfoSpan = document.getElementById("user-info");

// === Login / Logout ===
loginGoogle.onclick = async () => {
  const provider = new firebase.auth.GoogleAuthProvider();
  try { await auth.signInWithPopup(provider); } catch(e) { alert("Google Login Fehler: " + e.message); }
};

loginApple.onclick = async () => {
  const provider = new firebase.auth.OAuthProvider('apple.com');
  provider.addScope('email'); provider.addScope('name');
  try { await auth.signInWithPopup(provider); } catch(e) { alert("Apple Login Fehler: " + e.message); }
};

logoutBtn.onclick = () => auth.signOut();

auth.onAuthStateChanged(async (user) => {
  if (user) {
    userInfoSpan.textContent = (user.email || user.displayName || user.uid).slice(0,20) + "...";
    logoutBtn.style.display = "inline-block";
    loginGoogle.style.display = "none";
    loginApple.style.display = "none";
    await loadMonthListFromFirestore();
    await calculateYear();
  } else {
    userInfoSpan.textContent = "Nicht angemeldet";
    logoutBtn.style.display = "none";
    loginGoogle.style.display = "inline-block";
    loginApple.style.display = "inline-block";
    savedMonths.innerHTML = '<option value="">üìÇ Gespeicherte Monate</option>';
    deleteMonthBtn.style.display = "none";
    tbody.innerHTML = ""; extraAmount.value = "0"; monthInput.value = "";
    for(let i=0;i<5;i++) addRow({});
    updateSummary(0, 0, 0); updateYearSummary(0, 0);
  }
});

// üî• üéØ DEFINITIVER FIX: addRow() - GELADENE DATEN WERDEN ERHALTEN!
function addRow(data = {}) {
  const tr = document.createElement("tr");
  
  // 1. HTML mit geladenen Daten setzen
  tr.innerHTML = `
    <td><input type="date" value="${data.date || ''}"></td>
    <td>
      <select>
        <option value=""></option>
        <option value="normal" ${data.type === 'normal' ? 'selected' : ''}>normal</option>
        <option value="doppel" ${data.type === 'doppel' ? 'selected' : ''}>doppel</option>
        <option value="extra" ${data.type === 'extra' ? 'selected' : ''}>extra</option>
      </select>
    </td>
    <td><input type="number" min="0" value="${data.pallets || ''}"></td>
    <td class="salary">0 ‚Ç¨</td>
    <td><button class="danger" onclick="this.closest('tr').remove(); calculateAll();">‚úñ</button></td>
  `;
  
  const typeSelect = tr.querySelector("select");
  const palletsInput = tr.querySelector('input[type="number"]');
  
  // üî• FIX: Event-Handler NACHDEM DOM vollst√§ndig ist
  const updatePalletsField = () => {
    if (typeSelect.value === 'extra') {
      palletsInput.disabled = false;
      palletsInput.style.background = '#020617';
    } else {
      palletsInput.disabled = true;
      palletsInput.style.background = '#334155';
      // ‚úÖ PALLETS WERT BEI LADEN BEHALTEN! Nur neue Rows leeren
      if (!data.date) palletsInput.value = '';
    }
    calculateAll();
  };
  
  // Event-Handler setzen
  typeSelect.onchange = updatePalletsField;
  
  // üî• WICHTIG: Initialzustand VOR Event-Handlers setzen!
  const currentType = typeSelect.value;
  if (currentType === 'extra') {
    palletsInput.disabled = false;
    palletsInput.style.background = '#020617';
  } else {
    palletsInput.disabled = true;
    palletsInput.style.background = '#334155';
  }
  
  // Input Events
  tr.querySelectorAll("input").forEach(input => {
    input.oninput = calculateAll;
  });
  
  tbody.appendChild(tr);
}

// === UNVER√ÑNDERT: Berechnungsfunktionen ===
function round5(v) { return Math.ceil(v / 5) * 5; }
function calc(type, p) {
  if (type === 'normal') return 45;
  if (type === 'doppel') return 90;
  if (type === 'extra') return round5(45 + Math.max(0, p - 17) * 3.3);
  return 0;
}
function parseDate(dateStr) { if (!dateStr) return null; return new Date(dateStr); }

function calculateAll() {
  const month = monthInput.value;
  if (!month) { updateSummary(0, 0, 0); return; }
  
  const [y, m] = month.split('-').map(Number);
  const start = new Date(y, m - 2, 21);
  const end = new Date(y, m - 1, 20);

  let shiftSum = 0, count = 0;
  Array.from(tbody.children).forEach(row => {
    const dateInput = row.children[0].querySelector('input');
    const typeSelect = row.children[1].querySelector('select');
    const palletsInput = row.children[2].querySelector('input');
    
    const dateStr = dateInput.value;
    const type = typeSelect.value;
    const pallets = +palletsInput.value || 0;
    const date = parseDate(dateStr);
    
    let salary = 0;
    if (date && type) {
      if (type !== 'extra' && palletsInput.value) palletsInput.value = '';
      if (type === 'extra' && pallets < 0) palletsInput.value = 0;
      if (date >= start && date <= end) {
        salary = calc(type, pallets);
        shiftSum += salary;
        count++;
      }
    }
    row.querySelector(".salary").textContent = salary + " ‚Ç¨";
  });

  const extra = +extraAmount.value || 0;
  updateSummary(shiftSum, count, shiftSum + extra);
}

function updateSummary(shiftSum, count, total) {
  shiftSalary.textContent = shiftSum + " ‚Ç¨";
  totalSalary.textContent = total + " ‚Ç¨";
  totalShifts.textContent = count;
}

// Event Listeners
monthInput.onchange = calculateAll;
extraAmount.oninput = calculateAll;

// üî• loadSelectedMonth - OPTIMIERTE VERSION
async function loadSelectedMonth() {
  const month = savedMonths.value;
  const user = auth.currentUser;
  if (!month || !user) return;

  monthInput.value = month;
  tbody.innerHTML = '';

  try {
    const doc = await db.collection('users').doc(user.uid)
      .collection('months').doc(month).get();

    if (doc.exists) {
      const data = doc.data();
      extraAmount.value = data.extraAmount || '0';
      
      const rows = data.rows || [];
      rows.forEach(rowData => {
        if (rowData.date && rowData.type) {
          addRow(rowData);
        }
      });
      
      while (tbody.children.length < 5) {
        addRow({});
      }
      
      setTimeout(calculateAll, 300);
    } else {
      extraAmount.value = '0';
      for (let i = 0; i < 5; i++) addRow({});
      calculateAll();
    }
  } catch(e) {
    console.error(e);
    alert('Laden fehlgeschlagen: ' + e.message);
  }
}

async function saveMonth() {
  const month = monthInput.value, user = auth.currentUser;
  if (!month) return alert('‚ùå Bitte Monat w√§hlen!');
  if (!user) return alert('‚ùå Bitte zuerst anmelden!');
  
  const rows = Array.from(tbody.children).map(row => {
    const dateInput = row.children[0].querySelector('input');
    const typeSelect = row.children[1].querySelector('select');
    const palletsInput = row.children[2].querySelector('input');
    return {
      date: dateInput.value || '',
      type: typeSelect.value || '',
      pallets: palletsInput.value || ''
    };
  }).filter(row => row.date && row.type);

  const extra = +extraAmount.value || 0;
  if (rows.length === 0 && extra === 0) return alert('‚ùå Keine Daten zum Speichern!');

  try {
    await db.collection('users').doc(user.uid).collection('months').doc(month).set({
      rows, extraAmount: extra, updated: firebase.firestore.FieldValue.serverTimestamp(),
      count: rows.length, shiftTotal: rows.reduce((sum, r) => sum + calc(r.type, +r.pallets || 0), 0),
      total: rows.reduce((sum, r) => sum + calc(r.type, +r.pallets || 0), 0) + extra
    });
    await loadMonthListFromFirestore();
    alert('‚úÖ Monat gespeichert!');
  } catch (error) {
    console.error("‚ùå Speicherfehler:", error);
    alert("‚ùå Speicherfehler: " + error.message);
  }
}

async function deleteSelectedMonth() {
  const month = savedMonths.value, user = auth.currentUser;
  if (!month) return alert('Bitte Monat ausw√§hlen!');
  if (!user) return alert('Bitte anmelden!');
  if (!confirm(`üóëÔ∏è Wirklich "${month}" l√∂schen?`)) return;

  try {
    await db.collection('users').doc(user.uid).collection('months').doc(month).delete();
    alert('‚úÖ Monat gel√∂scht!');
    savedMonths.value = ''; deleteMonthBtn.style.display = 'none';
    monthInput.value = ''; extraAmount.value = '0'; tbody.innerHTML = '';
    for (let i = 0; i < 5; i++) addRow({});
    calculateAll();
    await loadMonthListFromFirestore();
    await calculateYear();
  } catch (e) {
    console.error(e);
    alert("‚ùå L√∂schen fehlgeschlagen: " + e.message);
  }
}

async function loadMonthListFromFirestore() {
  const user = auth.currentUser;
  if (!user) return;
  savedMonths.innerHTML = '<option value="">üìÇ Gespeicherte Monate</option>';
  deleteMonthBtn.style.display = 'none';
  
  try {
    const snapshot = await db.collection('users').doc(user.uid)
      .collection('months').orderBy('updated', 'desc').get();
    snapshot.docs.forEach(doc => {
      const id = doc.id, data = doc.data();
      const option = document.createElement('option');
      option.value = id;
      option.textContent = `${id} (${data.count || 0} Schichten, ${data.total?.toFixed(2) || 0}‚Ç¨)`;
      savedMonths.appendChild(option);
    });
    deleteMonthBtn.style.display = snapshot.size > 0 ? 'inline-block' : 'none';
  } catch (e) { console.error(e); }
}

async function calculateYear() {
  const user = auth.currentUser;
  if (!user) { updateYearSummary(0, 0); return; }
  try {
    const snapshot = await db.collection('users').doc(user.uid).collection('months').get();
    let sum = 0, count = 0;
    snapshot.docs.forEach(doc => {
      const data = doc.data();
      sum += data.total || 0;
      count += data.count || 0;
    });
    updateYearSummary(sum, count);
  } catch (e) {
    console.error(e);
    updateYearSummary(0, 0);
  }
}

function updateYearSummary(sum, count) {
  yearSalary.textContent = sum.toFixed(2) + ' ‚Ç¨';
  yearShifts.textContent = count;
}

savedMonths.onchange = () => deleteMonthBtn.style.display = savedMonths.value ? 'inline-block' : 'none';

// Initialisierung
for (let i = 0; i < 5; i++) addRow({});
calculateAll();
</script>
</body>
</html>
