<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Arbeitszeiten & Gehaltsrechner</title>

<style>
:root{
  --bg:#0f172a;
  --card:#1e293b;
  --text:#e5e7eb;
  --muted:#94a3b8;
  --accent:#38bdf8;
  --danger:#ef4444;
}
*{box-sizing:border-box}
body{
  margin:0;
  font-family:system-ui,sans-serif;
  background:var(--bg);
  color:var(--text);
  padding:16px;
}
.container{max-width:1100px;margin:auto;}
.card{
  background:var(--card);
  border-radius:14px;
  padding:16px;
  margin-bottom:16px;
}
.flex{display:flex;gap:10px;flex-wrap:wrap;align-items:end;}
input,select{
  width:100%;padding:10px;border-radius:8px;border:none;
  background:#020617;color:var(--text);
}
button{
  padding:10px 12px;border-radius:8px;border:none;
  font-weight:600;cursor:pointer;
}
.primary{background:var(--accent);color:#020617}
.secondary{background:#334155;color:var(--text)}
.danger{background:var(--danger);color:white}
.delete{background:#f59e0b;color:white}
.salary{font-weight:700;color:var(--accent);}
table{width:100%;border-collapse:collapse;min-width:700px}
th,td{padding:10px;text-align:center;}
th{color:var(--muted)}
tr:not(:last-child){border-bottom:1px solid #334155}
</style>
</head>

<body>
<div class="container">
<h1>üóìÔ∏è Arbeitszeiten & Gehaltsrechner</h1>

<div class="card flex">
  <div>
    <label>Abrechnungsmonat</label>
    <input type="month" id="month">
  </div>
  <div>
    <label>Sonstiges (‚Ç¨)</label>
    <input type="number" id="extraAmount" value="0">
  </div>
  <button class="primary" onclick="saveMonth()">üíæ Speichern</button>
  <select id="savedMonths" onchange="loadSelectedMonth()">
    <option value="">üìÇ Gespeicherte Monate</option>
  </select>
  <button class="delete" id="deleteMonth" onclick="deleteSelectedMonth()" style="display:none;">üóëÔ∏è</button>
</div>

<div class="card">
<table>
<thead>
<tr><th>Datum</th><th>Schicht</th><th>Paletten</th><th>‚Ç¨</th><th></th></tr>
</thead>
<tbody id="tbody"></tbody>
</table>
<br>
<button class="primary" onclick="addRow()">‚ûï Schicht hinzuf√ºgen</button>
</div>

<div class="card">
  <h2>üìä Monats√ºbersicht</h2>
  <p>Schichten: <span id="totalShifts">0</span></p>
  <p>Schicht-Gehalt: <span id="shiftSalary">0 ‚Ç¨</span></p>
  <p><strong>Gesamt: <span id="totalSalary">0 ‚Ç¨</span></strong></p>
</div>

<div class="card">
  <h2>üìÖ Jahres√ºbersicht</h2>
  <p>Schichten Jahr: <span id="yearShifts">0</span></p>
  <p>Gehalt Jahr: <span id="yearSalary">0 ‚Ç¨</span></p>
</div>
</div>

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore-compat.js"></script>

<script>
const firebaseConfig = {
  apiKey: "AIzaSyBkOZNvEpg0OcBkffwtyDm-ar6VAeucYFk",
  authDomain: "arbeitszeit-c3243.firebaseapp.com",
  projectId: "arbeitszeit-c3243",
};
firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db = firebase.firestore();

const tbody = document.getElementById("tbody");
const monthInput = document.getElementById("month");
const extraAmount = document.getElementById("extraAmount");
const savedMonths = document.getElementById("savedMonths");
const deleteMonthBtn = document.getElementById("deleteMonth");

const totalSalary = document.getElementById("totalSalary");
const shiftSalary = document.getElementById("shiftSalary");
const totalShifts = document.getElementById("totalShifts");
const yearSalary = document.getElementById("yearSalary");
const yearShifts = document.getElementById("yearShifts");

auth.signInAnonymously();

function addRow(data = {}) {
  const tr = document.createElement("tr");
  tr.innerHTML = `
    <td><input type="date" value="${data.date||''}"></td>
    <td>
      <select>
        <option value=""></option>
        <option value="normal" ${data.type==='normal'?'selected':''}>normal</option>
        <option value="doppel" ${data.type==='doppel'?'selected':''}>doppel</option>
        <option value="extra" ${data.type==='extra'?'selected':''}>extra</option>
      </select>
    </td>
    <td><input type="number" value="${data.pallets||''}"></td>
    <td class="salary">0 ‚Ç¨</td>
    <td><button class="danger" onclick="this.closest('tr').remove();calculateAll()">‚úñ</button></td>
  `;
  tr.querySelectorAll("input,select").forEach(e=>e.oninput=calculateAll);
  tbody.appendChild(tr);
}

function round5(v){return Math.ceil(v/5)*5}
function calc(type,p){
  if(type==='normal')return 45;
  if(type==='doppel')return 90;
  if(type==='extra')return round5(45+Math.max(0,p-17)*3.3);
  return 0;
}

function calculateAll(){
  if(!monthInput.value){updateSummary(0,0,0);return;}
  const [y,m]=monthInput.value.split('-').map(Number);
  const start=new Date(y,m-2,21), end=new Date(y,m-1,20);

  let sum=0,count=0;
  [...tbody.children].forEach(r=>{
    const d=new Date(r.children[0].querySelector('input').value);
    const t=r.children[1].querySelector('select').value;
    const p=+r.children[2].querySelector('input').value||0;
    let s=0;
    if(d>=start&&d<=end&&t){s=calc(t,p);sum+=s;count++;}
    r.querySelector(".salary").textContent=s+" ‚Ç¨";
  });
  const extra=+extraAmount.value||0;
  updateSummary(sum,count,sum+extra);
}

function updateSummary(sum,count,total){
  shiftSalary.textContent=sum+" ‚Ç¨";
  totalSalary.textContent=total+" ‚Ç¨";
  totalShifts.textContent=count;
}

async function saveMonth(){
  const user=auth.currentUser;
  if(!user||!monthInput.value)return;

  const [y,m]=monthInput.value.split('-').map(Number);
  const start=new Date(y,m-2,21), end=new Date(y,m-1,20);

  const rows=[...tbody.children].map(r=>{
    const d=new Date(r.children[0].querySelector('input').value);
    if(!(d>=start&&d<=end))return null;
    return {
      date:r.children[0].querySelector('input').value,
      type:r.children[1].querySelector('select').value,
      pallets:r.children[2].querySelector('input').value
    };
  }).filter(r=>r&&r.type);

  const extra=+extraAmount.value||0;
  const total=rows.reduce((s,r)=>s+calc(r.type,+r.pallets||0),0)+extra;

  await db.collection('users').doc(user.uid)
    .collection('months').doc(monthInput.value)
    .set({rows,extra,total,count:rows.length,updated:new Date()});

  await loadMonthList();
  await calculateYear();
  alert("‚úÖ Monat gespeichert");
}

async function loadSelectedMonth(){
  const user=auth.currentUser;
  if(!user||!savedMonths.value)return;
  tbody.innerHTML='';
  const doc=await db.collection('users').doc(user.uid)
    .collection('months').doc(savedMonths.value).get();
  doc.data().rows.forEach(addRow);
  extraAmount.value=doc.data().extra||0;
  while(tbody.children.length<5)addRow();
  calculateAll();
}

async function loadMonthList(){
  const user=auth.currentUser;
  if(!user)return;
  savedMonths.innerHTML='<option value="">üìÇ Gespeicherte Monate</option>';
  const snap=await db.collection('users').doc(user.uid)
    .collection('months').orderBy('updated','desc').get();
  snap.forEach(d=>{
    const o=document.createElement('option');
    o.value=d.id;
    o.textContent=`${d.id} (${d.data().count} Schichten, ${d.data().total}‚Ç¨)`;
    savedMonths.appendChild(o);
  });
}

async function calculateYear(){
  const user=auth.currentUser;
  if(!user)return;
  let sum=0,count=0;
  const snap=await db.collection('users').doc(user.uid).collection('months').get();
  snap.forEach(d=>{sum+=d.data().total||0;count+=d.data().count||0});
  yearSalary.textContent=sum+" ‚Ç¨";
  yearShifts.textContent=count;
}

for(let i=0;i<5;i++)addRow();
</script>
</body>
</html>
