<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<meta http-equiv="Content-Security-Policy" content="
  default-src 'self';
  script-src 'self' https://www.gstatic.com 'unsafe-inline';
  style-src 'self' 'unsafe-inline';
  connect-src 'self' https://arbeitszeit-c3243.firebaseapp.com https://*.googleapis.com https://*.firebaseio.com;
  img-src 'self'  https:;
  font-src 'self' ;
">
<title>Arbeitszeiten & Gehaltsrechner (Online)</title>

<style>
:root{
  --bg:#0f172a;
  --card:#1e293b;
  --text:#e5e7eb;
  --muted:#94a3b8;
  --accent:#38bdf8;
  --danger:#ef4444;
}
*{box-sizing:border-box}
body{
  margin:0;
  font-family:system-ui, sans-serif;
  background:var(--bg);
  color:var(--text);
  padding:16px;
}
.container{max-width:1100px;margin:auto;}
h1,h2{margin:8px 0;}
.card{
  background:var(--card);
  border-radius:14px;
  padding:16px;
  margin-bottom:16px;
  box-shadow:0 10px 30px rgba(0,0,0,.35);
}
.flex{
  display:flex;
  gap:10px;
  flex-wrap:wrap;
  align-items:end;
}
.table-wrapper{overflow-x:auto;}
table{
  width:100%;
  border-collapse:collapse;
  min-width:700px;
}
th,td{padding:10px;text-align:center;}
th{color:var(--muted);font-weight:500;}
tr:not(:last-child){border-bottom:1px solid #334155;}
input,select{
  width:100%;
  padding:10px;
  border-radius:8px;
  border:none;
  background:#020617;
  color:var(--text);
  font-size:1em;
}
button{
  padding:10px 12px;
  border-radius:8px;
  border:none;
  cursor:pointer;
  font-weight:600;
  font-size:0.95em;
}
.primary{background:var(--accent);color:#020617}
.secondary{background:#334155;color:var(--text)}
.danger{background:var(--danger);color:white}
.delete{background:#f59e0b;color:white}
button:hover{opacity:.85}
.salary{font-weight:700;color:var(--accent);}
.summary p{font-size:1.1em;margin:6px 0;}
#user-bar{display:flex;gap:8px;align-items:center;flex-wrap:wrap;}
#extra-amount {flex: 1; min-width: 200px;}
.extra-field {
  display: flex;
  flex-direction: column;
  gap: 4px;
}
.status{display:flex;align-items:center;gap:8px;padding:8px;background:#1e40af;border-radius:8px;color:white;margin-bottom:16px;}
.status.ok{background:#059669;}
.status.error{background:var(--danger);}

@media(max-width:700px){
  h1{font-size:1.4em;}
  table{font-size:.9em;}
}
label{display:block;margin-bottom:4px;font-size:0.9em;color:var(--muted);}
</style>
</head>

<body>
<div class="container">

<h1>üóìÔ∏è Arbeitszeiten & Gehaltsrechner (Online)</h1>

<div class="card" id="user-bar">
  <button class="secondary" id="login-google">Mit Google anmelden</button>
  <button class="secondary" id="login-apple">Mit Apple anmelden</button>
  <button class="danger" id="logout" style="display:none;">Abmelden</button>
  <span id="user-info"></span>
  <div id="status" class="status" style="display:none;"></div>
</div>

<div class="card flex">
  <div style="flex:1;">
    <label for="month">Abrechnungsmonat</label>
    <input type="month" id="month" name="month">
  </div>
  <div id="extra-amount" class="extra-field">
    <label for="extraAmount">Sonstiges (‚Ç¨)</label>
    <input type="number" id="extraAmount" name="extraAmount" min="0" step="0.01" value="0" placeholder="z.B. 50.00">
  </div>
  <button class="primary" onclick="saveMonth()">üíæ Speichern</button>
  <select id="savedMonths" name="savedMonths" onchange="loadSelectedMonth()">
    <option value="">üìÇ Gespeicherte Monate</option>
  </select>
  <button class="delete" id="deleteMonth" name="deleteMonth" onclick="deleteSelectedMonth()" style="display:none;" title="Ausgew√§hlten Monat l√∂schen">üóëÔ∏è L√∂schen</button>
</div>

<div class="card">
  <div class="table-wrapper">
    <table>
      <thead>
        <tr>
          <th>Datum</th>
          <th>Schicht</th>
          <th>Paletten</th>
          <th>‚Ç¨</th>
          <th></th>
        </tr>
      </thead>
      <tbody id="tbody"></tbody>
    </table>
  </div>
  <br>
  <button class="primary" onclick="addRow()">‚ûï Schicht hinzuf√ºgen</button>
</div>

<div class="card summary">
  <h2>üìä Monats√ºbersicht</h2>
  <p>Schichten gesamt: <span id="totalShifts">0</span></p>
  <p>Schicht-Gehalt: <span id="shiftSalary">0 ‚Ç¨</span></p>
  <p><strong>Gesamt (inkl. sonstiges): <span id="totalSalary">0 ‚Ç¨</span></strong></p>
</div>

<div class="card summary">
  <h2>üìÖ Jahres√ºbersicht</h2>
  <p>Schichten Jahr: <span id="yearShifts">0</span></p>
  <p>Gehalt Jahr: <span id="yearSalary">0 ‚Ç¨</span></p>
</div>

</div>

<!-- Firebase SDKs -->
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore-compat.js"></script>

<script>
// === FIREBASE CONFIG ===
const firebaseConfig = {
  apiKey: "AIzaSyBkOZNvEpg0OcBkffwtyDm-ar6VAeucYFk",
  authDomain: "arbeitszeit-c3243.firebaseapp.com",
  projectId: "arbeitszeit-c3243",
  storageBucket: "arbeitszeit-c3243.firebasestorage.app",
  messagingSenderId: "8215248023",
  appId: "1:8215248023:web:cf7465987b5cdfa36fbdd2"
};

firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db = firebase.firestore();

// === DOM-Elemente ===
const tbody = document.getElementById("tbody");
const monthInput = document.getElementById("month");
const extraAmount = document.getElementById("extraAmount");
const savedMonths = document.getElementById("savedMonths");
const deleteMonthBtn = document.getElementById("deleteMonth");
const totalSalary = document.getElementById("totalSalary");
const shiftSalary = document.getElementById("shiftSalary");
const totalShifts = document.getElementById("totalShifts");
const yearSalary = document.getElementById("yearSalary");
const yearShifts = document.getElementById("yearShifts");
const loginGoogle = document.getElementById("login-google");
const loginApple = document.getElementById("login-apple");
const logoutBtn = document.getElementById("logout");
const userInfoSpan = document.getElementById("user-info");
const statusDiv = document.getElementById("status");

// üî• STATUS HELFER
function showStatus(message, isError = false) {
  statusDiv.textContent = message;
  statusDiv.className = `status ${isError ? 'error' : 'ok'}`;
  statusDiv.style.display = 'flex';
  setTimeout(() => statusDiv.style.display = 'none', 5000);
}

// üî• EVENT DELEGATION
tbody.addEventListener('change', function(e) {
  const row = e.target.closest('tr');
  if (!row) return;
  if (e.target.tagName === 'SELECT' || e.target.tagName === 'INPUT') {
    handleRowChange(row);
  }
});

tbody.addEventListener('input', function(e) {
  const row = e.target.closest('tr');
  if (!row) return;
  if (e.target.type === 'date' || e.target.type === 'number') {
    handleRowChange(row);
  }
});

tbody.addEventListener('click', function(e) {
  if (e.target.classList.contains('delete-btn')) {
    e.target.closest('tr').remove();
    calculateAll();
  }
});

function handleRowChange(row) {
  const typeSelect = row.querySelector('select');
  const palletsInput = row.querySelector('input[type="number"]');
  
  if (typeSelect && palletsInput) {
    if (typeSelect.value === 'extra') {
      palletsInput.disabled = false;
      palletsInput.style.background = '#020617';
    } else {
      palletsInput.disabled = true;
      palletsInput.style.background = '#334155';
      palletsInput.value = '';
    }
  }
  calculateAll();
}

// === Login / Logout ===
loginGoogle.onclick = async function() {
  try {
    const provider = new firebase.auth.GoogleAuthProvider();
    await auth.signInWithPopup(provider);
  } catch(e) {
    showStatus("Google Login Fehler: " + e.message, true);
  }
};

loginApple.onclick = async function() {
  try {
    const provider = new firebase.auth.OAuthProvider('apple.com');
    provider.addScope('email');
    provider.addScope('name');
    await auth.signInWithPopup(provider);
  } catch(e) {
    showStatus("Apple Login Fehler: " + e.message, true);
  }
};

logoutBtn.onclick = function() { auth.signOut(); };

auth.onAuthStateChanged(async function(user) {
  if (user) {
    userInfoSpan.textContent = (user.email || user.displayName || user.uid).slice(0,20) + "...";
    logoutBtn.style.display = "inline-block";
    loginGoogle.style.display = "none";
    loginApple.style.display = "none";
    await loadMonthListFromFirestore();
    await calculateYear();
  } else {
    userInfoSpan.textContent = "Nicht angemeldet";
    logoutBtn.style.display = "none";
    loginGoogle.style.display = "inline-block";
    loginApple.style.display = "inline-block";
    savedMonths.innerHTML = '<option value="">üìÇ Gespeicherte Monate</option>';
    deleteMonthBtn.style.display = "none";
    tbody.innerHTML = "";
    extraAmount.value = "0";
    for(let i=0;i<5;i++) addRow();
    updateSummary(0, 0, 0);
    updateYearSummary(0, 0);
  }
});

// üî• addRow()
function addRow(data) {
  const tr = document.createElement("tr");
  tr.innerHTML = `
    <td><input type="date" value="${data ? (data.date || '') : ''}" id="date-${Date.now()}"></td>
    <td>
      <select>
        <option value="">--</option>
        <option value="normal" ${data && data.type === 'normal' ? 'selected' : ''}>normal</option>
        <option value="doppel" ${data && data.type === 'doppel' ? 'selected' : ''}>doppel</option>
        <option value="extra" ${data && data.type === 'extra' ? 'selected' : ''}>extra</option>
      </select>
    </td>
    <td><input type="number" min="0" value="${data ? (data.pallets || '') : ''}" id="pallets-${Date.now()}"></td>
    <td class="salary">0 ‚Ç¨</td>
    <td><button type="button" class="danger delete-btn">‚úñ</button></td>
  `;
  tbody.appendChild(tr);
}

// Berechnungen
function round5(v) { return Math.ceil(v / 5) * 5; }
function calc(type, p) {
  if (type === 'normal') return 45;
  if (type === 'doppel') return 90;
  if (type === 'extra') return round5(45 + Math.max(0, p - 17) * 3.3);
  return 0;
}
function parseDate(dateStr) {
  if (!dateStr) return null;
  return new Date(dateStr);
}

function calculateAll() {
  const month = monthInput.value;
  if (!month) {
    updateSummary(0, 0, 0);
    return;
  }
  
  const [y, m] = month.split('-').map(Number);
  const start = new Date(y, m - 2, 21);
  const end = new Date(y, m - 1, 20);

  let shiftSum = 0, count = 0;

  Array.from(tbody.children).forEach(function(row) {
    try {
      const dateInput = row.children[0].querySelector('input[type="date"]');
      const typeSelect = row.children[1].querySelector('select');
      const palletsInput = row.children[2].querySelector('input[type="number"]');
      
      if (!dateInput || !typeSelect || !palletsInput) return;
      
      const dateStr = dateInput.value;
      const type = typeSelect.value;
      const pallets = +palletsInput.value || 0;
      const date = parseDate(dateStr);
      
      let salary = 0;
      if (date && type && date >= start && date <= end) {
        salary = calc(type, pallets);
        shiftSum += salary;
        count++;
      }
      row.querySelector(".salary").textContent = salary + " ‚Ç¨";
    } catch(e) {
      console.warn("Fehler bei Zeilenberechnung:", e);
    }
  });

  const extra = +extraAmount.value || 0;
  const total = shiftSum + extra;
  updateSummary(shiftSum, count, total);
  calculateYear();
}

function updateSummary(shiftSum, count, total) {
  shiftSalary.textContent = shiftSum + " ‚Ç¨";
  totalSalary.textContent = total + " ‚Ç¨";
  totalShifts.textContent = count;
}

// üî• Jahres√ºbersicht IMMER laden
async function calculateYear() {
  const user = auth.currentUser;
  if (!user) {
    updateYearSummary(0, 0);
    return;
  }
  
  try {
    const snapshot = await db.collection('users').doc(user.uid)
      .collection('months').get();

    let sum = 0, count = 0;
    snapshot.docs.forEach(function(doc) {
      const data = doc.data();
      sum += data.total || 0;
      count += data.count || 0;
    });
    updateYearSummary(sum, count);
  } catch (e) {
    console.error('Jahres√ºbersicht Fehler:', e);
    updateYearSummary(0, 0);
  }
}

function updateYearSummary(sum, count) {
  yearSalary.textContent = sum.toLocaleString() + ' ‚Ç¨';
  yearShifts.textContent = count.toLocaleString();
}

// Event Listeners
monthInput.onchange = calculateAll;
extraAmount.oninput = calculateAll;
savedMonths.onchange = function() {
  deleteMonthBtn.style.display = savedMonths.value ? 'inline-block' : 'none';
};

// Firebase Funktionen
async function saveMonth() {
  const month = monthInput.value;
  const user = auth.currentUser;
  
  if (!month) return showStatus('‚ùå Bitte Monat w√§hlen!', true);
  if (!user) return showStatus('‚ùå Bitte zuerst anmelden!', true);

  const rows = Array.from(tbody.children).map(function(row) {
    const dateInput = row.children[0].querySelector('input');
    const typeSelect = row.children[1].querySelector('select');
    const palletsInput = row.children[2].querySelector('input');
    return {
      date: dateInput.value || '',
      type: typeSelect.value || '',
      pallets: palletsInput.value || ''
    };
  }).filter(function(row) { return row.date && row.type; });

  const extra = +extraAmount.value || 0;
  if (rows.length === 0 && extra === 0) {
    return showStatus('‚ùå Keine Daten zum Speichern!', true);
  }

  try {
    await db.collection('users').doc(user.uid)
      .collection('months').doc(month)
      .set({
        rows: rows,
        extraAmount: extra,
        updated: firebase.firestore.FieldValue.serverTimestamp(),
        count: rows.length,
        shiftTotal: rows.reduce(function(sum, r) { return sum + calc(r.type, +r.pallets || 0); }, 0),
        total: rows.reduce(function(sum, r) { return sum + calc(r.type, +r.pallets || 0); }, 0) + extra
      });
    
    await loadMonthListFromFirestore();
    showStatus('‚úÖ Monat gespeichert!');
  } catch (error) {
    console.error("Speicherfehler:", error);
    showStatus("‚ùå Speicherfehler: " + error.message, true);
  }
}

async function deleteSelectedMonth() {
  const month = savedMonths.value;
  const user = auth.currentUser;
  
  if (!month) return showStatus('Bitte Monat ausw√§hlen!', true);
  if (!user) return showStatus('Bitte anmelden!', true);
  if (!confirm(`üóëÔ∏è Wirklich "${month}" l√∂schen?`)) return;

  try {
    await db.collection('users').doc(user.uid)
      .collection('months').doc(month).delete();
    
    showStatus('‚úÖ Monat gel√∂scht!');
    savedMonths.value = '';
    deleteMonthBtn.style.display = 'none';
    monthInput.value = '';
    extraAmount.value = '0';
    tbody.innerHTML = '';
    for (let i = 0; i < 5; i++) addRow();
    calculateAll();
    await loadMonthListFromFirestore();
  } catch (e) {
    console.error(e);
    showStatus("‚ùå L√∂schen fehlgeschlagen: " + e.message, true);
  }
}

async function loadMonthListFromFirestore() {
  const user = auth.currentUser;
  if (!user) return;
  
  savedMonths.innerHTML = '<option value="">üìÇ Gespeicherte Monate</option>';
  deleteMonthBtn.style.display = 'none';
  
  try {
    const snapshot = await db.collection('users').doc(user.uid)
      .collection('months').orderBy('updated', 'desc').get();

    snapshot.docs.forEach(function(doc) {
      const id = doc.id;
      const data = doc.data();
      const option = document.createElement('option');
      option.value = id;
      option.textContent = `${id} (${data.count || 0} Schichten, ${data.total || 0}‚Ç¨)`;
      savedMonths.appendChild(option);
    });
    
    deleteMonthBtn.style.display = snapshot.size > 0 ? 'inline-block' : 'none';
  } catch (e) {
    console.error('Monatsliste Fehler:', e);
  }
}

async function loadSelectedMonth() {
  const month = savedMonths.value;
  const user = auth.currentUser;
  if (!month || !user) return;

  try {
    monthInput.value = month;
    tbody.innerHTML = '';

    const doc = await db.collection('users').doc(user.uid)
      .collection('months').doc(month).get();

    if (doc.exists) {
      const data = doc.data();
      extraAmount.value = data.extraAmount || '0';
      const rows = data.rows || [];

      rows.forEach(function(rowData) { addRow(rowData); });
      while (tbody.children.length < 5) addRow();
    } else {
      for(let i = 0; i < 5; i++) addRow();
    }
    
    calculateAll();
  } catch (e) {
    console.error('Laden fehlgeschlagen:', e);
    showStatus('Laden fehlgeschlagen: ' + e.message, true);
    tbody.innerHTML = '';
    for(let i = 0; i < 5; i++) addRow();
    calculateAll();
  }
}

// üî• START
for (let i = 0; i < 5; i++) {
  addRow();
}
</script>

</body>
</html>
